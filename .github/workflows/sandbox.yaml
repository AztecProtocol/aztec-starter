name: Sandbox Tests

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  sandbox-tests:
    name: Sandbox Tests
    runs-on: ubuntu-latest
    env:
      ENV: sandbox

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install Aztec CLI
        run: |
          curl -s https://install.aztec.network > tmp.sh
          bash tmp.sh <<< yes "yes"

      - name: Update path
        run: echo "/home/runner/.aztec/bin" >> $GITHUB_PATH

      - name: Set Aztec version and start sandbox
        run: |
          VERSION=2.0.2 aztec-up
          aztec start --sandbox &

      - name: Wait for sandbox to be ready
        run: |
          echo "Waiting for sandbox to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/status >/dev/null 2>&1; then
              echo "✅ Sandbox is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 5
          done

      - name: Install project dependencies
        run: yarn

      - name: Compile contracts
        run: script -e -c "${AZTEC_NARGO:-aztec-nargo} compile"

      - name: Generate contract artifacts
        run: script -e -c "aztec codegen target --outdir src/artifacts && aztec-postprocess-contract"

      - name: Change ownership for nargo files
        run: sudo chown -R $(whoami) ~/nargo && sudo chown -R $(whoami) ~/nargo/github.com

      - name: Run JavaScript tests
        run: |
          script -e -c "rm -rf store/pxe"
          script -e -c "NODE_NO_WARNINGS=1 node --experimental-vm-modules $(yarn bin jest) --no-cache --runInBand --config jest.integration.config.json"

      - name: Run Aztec tests
        run: script -e -c "aztec test"

      - name: Deploy account and capture SECRET/SIGNING_KEY/SALT
        run: |
          script -e -c "yarn clear-store"
          # Create a temporary file to store the output
          # Show the full output for debugging
          cat "$TEMP_OUTPUT"

          # Extract SECRET, SIGNING_KEY, and SALT from the output
          SECRET_KEY=$(grep -o "🔑 Secret key generated: 0x[a-fA-F0-9]*" "$TEMP_OUTPUT" | head -1 | sed 's/🔑 Secret key generated: //' || echo "")
          SIGNING_KEY=$(grep -o "🖊️ Signing key generated: 0x[a-fA-F0-9]*" "$TEMP_OUTPUT" | head -1 | sed 's/🖊️ Signing key generated: //' || echo "")
          SALT_VALUE=$(grep -o "🧂 Salt generated: 0x[a-fA-F0-9]*" "$TEMP_OUTPUT" | head -1 | sed 's/🧂 Salt generated: //' || echo "")

          # Clean up temp file
          rm "$TEMP_OUTPUT"

          # Validate and create .env file
          if [ -n "$SECRET_KEY" ] && [ -n "$SIGNING_KEY" ] && [ -n "$SALT_VALUE" ]; then
            
            # Create .env file with all necessary values
            echo "SECRET=\"$SECRET_KEY\"" >> .env
            echo "SIGNING_KEY=\"$SIGNING_KEY\"" >> .env
            echo "SALT=\"$SALT_VALUE\"" >> .env
            echo "📋 Current .env file contents:"
            cat .env
          else
            echo "❌ Failed to extract SECRET, SIGNING_KEY and/or SALT from deploy output"
            echo "🔍 SECRET_KEY: '$SECRET_KEY'"
            echo "🔍 SIGNING_KEY: '$SIGNING_KEY'"
            echo "🔍 SALT_VALUE: '$SALT_VALUE'"
            exit 1
          fi