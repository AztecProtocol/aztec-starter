on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      - dev

jobs:
  setup-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Install Aztec CLI
        run: |
          curl -s https://install.aztec.network > tmp.sh
          bash tmp.sh <<< yes "yes"

      - name: Update path
        run: echo "/home/runner/.aztec/bin" >> $GITHUB_PATH

      - name: Set Aztec version and start sandbox
        run: |
          VERSION=0.84.0-alpha-testnet.1 aztec-up
          aztec start --sandbox --no-pxe &

      - name: Install project dependencies
        run: yarn

      - name: Compile
        run: script -e -c "${AZTEC_NARGO:-aztec-nargo} compile"

      - name: Codegen
        run: script -e -c "aztec codegen target --outdir src/artifacts"

      - name: Change ownership # to get around Docker issues
        run: sudo chown -R $(whoami) ~/nargo && sudo chown -R $(whoami) ~/nargo/github.com

      - name: Start PXE
        run: |
          aztec start --port 8081 --pxe --pxe.nodeUrl=http://localhost:8080/ --pxe.proverEnabled false &

      - name: Run scripts
        run: script -e -c "yarn deploy && yarn deploy-account && yarn fees"